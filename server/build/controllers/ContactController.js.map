{"version":3,"sources":["../../src/controllers/ContactController.js"],"names":["users","models","contacts","ContactController","req","res","body","receiverId","title","message","senderId","decode","id","findById","then","user","receiver","create","newMessage","catch","userId","parseInt","findAll","where","type","messages","length","clientsInfo","forEach","messageObj","getClient","sender","push"],"mappings":"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","file":"ContactController.js","sourcesContent":["import models from './../models/index';\r\nimport { handleResponse } from './../services/services';\r\n\r\nconst { users, contacts } = models;\r\n/* eslint-disable consistent-return */\r\nconst ContactController = class {\r\n  // create a new message\r\n  static addMessage(req, res) {\r\n    const {\r\n      receiverId,\r\n      title,\r\n      message,\r\n    } = req.body;\r\n    // sender is user with token\r\n    const senderId = req.body.decode.id;\r\n    return users\r\n      .findById(senderId)\r\n      .then((user) => {\r\n        if (user) {\r\n          return users\r\n            .findById(receiverId)\r\n            .then((receiver) => {\r\n              if (receiver) {\r\n                return contacts\r\n                  .create({\r\n                    receiverId,\r\n                    senderId,\r\n                    message,\r\n                    title,\r\n                  })\r\n                  .then((newMessage) => {\r\n                    return handleResponse(res, 201, newMessage);\r\n                  })\r\n                  .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n              }\r\n              return handleResponse(res, 404, 'receiver does not exist');\r\n            });\r\n        }\r\n        return handleResponse(res, 404, 'Your identity could not be verified. Please make sure you are logged in');\r\n      })\r\n      .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n  }\r\n\r\n  static getMessages(req, res) {\r\n    const userId = parseInt(req.body.decode.id, 10);\r\n    return contacts\r\n      .findAll({\r\n        where: {\r\n          senderId: userId,\r\n          receiverId: userId,\r\n        },\r\n        type: 'or',\r\n      })\r\n      .then((messages) => {\r\n        if (messages) {\r\n          // no messages has been send or received\r\n          if (messages.length === 0) {\r\n            return handleResponse(res, 200, []);\r\n          }\r\n          const clientsInfo = [];\r\n          messages.forEach((message) => {\r\n            // object to hold message sender and receiver\r\n            const messageObj = {};\r\n            messageObj.message = message;\r\n\r\n            // get info of message sender\r\n            return users\r\n              .getClient(message.senderId)\r\n              .then((sender) => {\r\n                return sender;\r\n              })\r\n              .then((sender) => {\r\n                if (sender) {\r\n                  messageObj.sender = sender;\r\n                } else {\r\n                  messageObj.sender = { message: 'user not found' };\r\n                }\r\n              })\r\n              .then(() => {\r\n                // get info of message receiver\r\n                return users\r\n                  .getClient(message.receiverId)\r\n                  .then((receiver) => {\r\n                    return receiver;\r\n                  })\r\n                  .then((receiver) => {\r\n                    if (receiver) {\r\n                      messageObj.receiver = receiver;\r\n                    } else {\r\n                      messageObj.receiver = { message: 'user not found' };\r\n                    }\r\n\r\n                    // push messageObj to collection\r\n                    clientsInfo.push(messageObj);\r\n                    if (clientsInfo.length === messages.length) {\r\n                      return handleResponse(res, 200, clientsInfo);\r\n                    }\r\n                  });\r\n              });\r\n          });\r\n        }\r\n      })\r\n      .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n  }\r\n};\r\n\r\nexport default ContactController;\r\n"]}