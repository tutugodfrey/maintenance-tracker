{"version":3,"sources":["../../src/controllers/RequestController.js"],"names":["requests","models","users","RequestController","req","res","body","category","description","address","urgent","adminId","userId","findById","parseInt","then","user","admin","serviceName","create","issueDate","updatedAt","status","request","catch","requestId","params","decode","id","find","where","getClient","client","message","findAll","clientRequests","length","clientsInfo","forEach","clientInfo","push","update","newRequest","destroy","rows"],"mappings":"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","file":"RequestController.js","sourcesContent":["\r\nimport models from './../models/index';\r\nimport { handleResponse } from './../services/services';\r\n\r\nconst { requests, users } = models;\r\n/* eslint-disable consistent-return */\r\nconst RequestController = class {\r\n  // add a new request\r\n  static addRequest(req, res) {\r\n    const {\r\n      category,\r\n      description,\r\n      address,\r\n      urgent,\r\n      adminId,\r\n      userId,\r\n    } = req.body;\r\n\r\n    return users.findById(parseInt(userId, 10))\r\n      .then((user) => {\r\n        if (user) {\r\n          return users\r\n            .findById(parseInt(adminId, 10))\r\n            .then((admin) => {\r\n              if (admin && admin.serviceName) {\r\n                return requests\r\n                  .create({\r\n                    userId,\r\n                    category,\r\n                    description,\r\n                    address,\r\n                    adminId,\r\n                    issueDate: 'now()',\r\n                    updatedAt: 'now()',\r\n                    status: 'awaiting confirmation',\r\n                    urgent: urgent || false,\r\n                  })\r\n                  .then(request => handleResponse(res, 201, request))\r\n                  .catch(() => handleResponse(res, 500, 'something went wrong! please try again later'));\r\n              }\r\n              return handleResponse(res, 404, 'service not found');\r\n            });\r\n        }\r\n        return handleResponse(res, 401, 'user identity not verified! please make sure you are logged in');\r\n      })\r\n      .catch(() => handleResponse(res, 500, 'something went wrong! please try again later'));\r\n  }\r\n\r\n  // get a signle requests for a logged in user\r\n  static getOneRequest(req, res) {\r\n    const requestId = parseInt(req.params.requestId, 10);\r\n    const userId = parseInt(req.body.decode.id, 10);\r\n    return requests\r\n      .find({\r\n        where: {\r\n          userId,\r\n          id: requestId,\r\n        },\r\n      })\r\n      .then((request) => {\r\n        if (!request) {\r\n          return handleResponse(res, 404, 'request not found');\r\n        }\r\n        return users\r\n          .getClient(request.adminId)\r\n          .then((client) => {\r\n            if (client) {\r\n              return handleResponse(res, 200, {\r\n                request,\r\n                user: client,\r\n              });\r\n            }\r\n            return handleResponse(res, 200, {\r\n              request,\r\n              user: { message: 'user not found' },\r\n            });\r\n          });\r\n      })\r\n      .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n  }\r\n\r\n  // get all request for a logged in user\r\n  static getAllRequests(req, res) {\r\n    const userId = parseInt(req.body.decode.id, 10);\r\n    return requests\r\n      .findAll({\r\n        where: {\r\n          userId,\r\n        },\r\n      })\r\n      .then((clientRequests) => {\r\n        if (clientRequests) {\r\n          if (clientRequests.length === 0) {\r\n            return handleResponse(res, 200, []);\r\n          }\r\n          const clientsInfo = [];\r\n          clientRequests.forEach((request) => {\r\n            return users\r\n              .getClient(request.adminId)\r\n              .then((clientInfo) => {\r\n                return clientInfo;\r\n              })\r\n              .then((clientInfo) => {\r\n                if (clientInfo) {\r\n                  clientsInfo.push({\r\n                    request,\r\n                    user: clientInfo,\r\n                  });\r\n                } else {\r\n                  clientsInfo.push({\r\n                    request,\r\n                    user: { message: 'user not found' },\r\n                  });\r\n                }\r\n                if (clientsInfo.length === clientRequests.length) {\r\n                  return handleResponse(res, 200, clientsInfo);\r\n                }\r\n              })\r\n              .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n          });\r\n        }\r\n      })\r\n      .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n  }\r\n\r\n  // update a request\r\n  static updateRequest(req, res) {\r\n    const {\r\n      category,\r\n      description,\r\n      address,\r\n      adminId,\r\n      urgent,\r\n    } = req.body;\r\n    const requestId = parseInt(req.params.requestId, 10);\r\n    const userId = parseInt(req.body.decode.id, 10);\r\n    return requests\r\n      .find({\r\n        where: {\r\n          userId,\r\n          id: requestId,\r\n        },\r\n      })\r\n      .then((request) => {\r\n        if (request) {\r\n          // users should not be able to modify the status of a request\r\n          if (request.status === 'pending' || request.status === 'resolved') {\r\n            return handleResponse(res, 200, 'request cannot be modify after it has been approved or resolved');\r\n          }\r\n          return requests\r\n            .update(\r\n              {\r\n                id: request.id,\r\n              },\r\n              {\r\n                updatedAt: 'now()',\r\n                category: category || request.category,\r\n                description: description || request.description,\r\n                address: address || request.address,\r\n                adminId: adminId || request.adminId,\r\n                urgent: urgent || request.urgent,\r\n              },\r\n            )\r\n            .then((newRequest) => {\r\n              // get the associated admin\r\n              return users\r\n                .getClient(newRequest.adminId)\r\n                .then((admin) => {\r\n                  if (admin) {\r\n                    return handleResponse(res, 200, {\r\n                      request: newRequest,\r\n                      user: admin,\r\n                    });\r\n                  }\r\n                  return handleResponse(res, 200, {\r\n                    request: newRequest,\r\n                    user: { message: 'user not found' },\r\n                  });\r\n                })\r\n                .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n            })\r\n            .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n        }\r\n        return handleResponse(res, 404, 'request not found');\r\n      })\r\n      .catch(() => handleResponse(res, 505, 'something went wrong. please try again'));\r\n  }\r\n\r\n  static deleteRequest(req, res) {\r\n    const requestId = parseInt(req.params.requestId, 10);\r\n    const userId = parseInt(req.body.decode.id, 10);\r\n    return requests\r\n      .destroy({\r\n        where: {\r\n          userId,\r\n          id: requestId,\r\n        },\r\n      })\r\n      .then((rows) => {\r\n        if (rows.length === 0) {\r\n          return handleResponse(res, 404, 'request not found, not action taken');\r\n        }\r\n        return handleResponse(res, 200, 'request has been deleted');\r\n      })\r\n      .catch(() => handleResponse(res, 500, 'something went wrong. please try again'));\r\n  }\r\n};\r\nexport default RequestController;\r\n"]}